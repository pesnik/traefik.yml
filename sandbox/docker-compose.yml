services:
  mcpo:
    container_name: mcpo
    image: ghcr.io/open-webui/mcpo:main
    restart: unless-stopped
    volumes:
      - ./mcpo-config:/app/config
    command: --host 0.0.0.0 --port 8000 --config /app/config/config.json
    networks:
      - traefik_default
  sandbox:
    container_name: aio-sandbox
    image: ghcr.io/agent-infra/sandbox:latest
    security_opt:
      - seccomp:unconfined
    extra_hosts:
      - 'host.docker.internal:host-gateway'
      - 'superset.banglalink.net:172.22.37.131'
    restart: 'unless-stopped'
    shm_size: '2gb'
    mem_limit: '8g'
    cpus: '4'
    # ports:
    #   - "${HOST_PORT:-8080}:8080"
    environment:
      PROXY_SERVER: ${PROXY_SERVER:-}
      JWT_PUBLIC_KEY: ${JWT_PUBLIC_KEY:-}
      DNS_OVER_HTTPS_TEMPLATES: ''
      WORKSPACE: ${WORKSPACE:-"/home/gem"}
      HOMEPAGE: ${HOMEPAGE:-}
      BROWSER_EXTRA_ARGS: ${BROWSER_EXTRA_ARGS:-}
      TZ: ${TZ:-Asia/Singapore}
      DISPLAY_WIDTH: ${DISPLAY_WIDTH:-1280}
      DISPLAY_HEIGHT: ${DISPLAY_HEIGHT:-1024}
      WAIT_PORTS: '8079,8091'
      VNC_SERVER_PORT: 5900
      PUBLIC_PORT: 8080
      AUTH_BACKEND_PORT: 8081
      WEBSOCKET_PROXY_PORT: 6080
      GEM_SERVER_PORT: 8088
      MCP_HUB_PORT: 8079
      SANDBOX_SRV_PORT: 8091
      JUPYTER_LAB_PORT: 8888
      CODE_SERVER_PORT: 8200
      MCP_SERVER_BROWSER_PORT: 8100
      TINYPROXY_PORT: 8118
      MCP_SERVER_MARKITDOWN_PORT: 8101
      MCP_SERVER_CHROME_DEVTOOLS_PORT: 8102
      BROWSER_REMOTE_DEBUGGING_PORT: 9222
      PIP_INDEX_URL: ${PIP_INDEX_URL:-https://pypi.org/simple}
      UV_DEFAULT_INDEX: ${UV_DEFAULT_INDEX:-https://pypi.org/simple}
      NPM_CONFIG_REGISTRY: ${NPM_CONFIG_REGISTRY:-https://registry.npmjs.org}
      # for gh cli
      GITHUB_TOKEN: ''
      # Claude Skills
      AIO_SKILLS_PATH: ${AIO_SKILLS_PATH:-}
      # Features
      DISABLE_JUPYTER: ${DISABLE_JUPYTER:-false}
      DISABLE_CODE_SERVER: ${DISABLE_CODE_SERVER:-false}
    labels:
      - 'traefik.enable=true'

      # UI Service (port 8080) - only via ui.sandbox.localhost
      - 'traefik.http.services.aio-sandbox-ui.loadbalancer.server.port=8080'
      - 'traefik.http.routers.sandbox-ui.rule=Host(`sandbox.localhost`)'
      - 'traefik.http.routers.sandbox-ui.entrypoints=web'
      - 'traefik.http.routers.sandbox-ui.service=aio-sandbox-ui'

      # API Service (port 8091) - works with both api.sandbox.localhost and 127.0.0.1/api-sandbox
      - 'traefik.http.services.aio-sandbox-api.loadbalancer.server.port=8091'
      - 'traefik.http.routers.sandbox.rule=Host(`api.sandbox.localhost`) || (Host(`127.0.0.1`) && PathPrefix(`/api-sandbox`))'
      - 'traefik.http.routers.sandbox.entrypoints=web'
      - 'traefik.http.routers.sandbox.service=aio-sandbox-api'
      - 'traefik.http.middlewares.sandbox-stripprefix.stripprefix.prefixes=/api-sandbox'
      - 'traefik.http.routers.sandbox.middlewares=sandbox-stripprefix'

      # VNC WebSocket (port 6080)
      - 'traefik.http.services.aio-vnc.loadbalancer.server.port=6080'
      - 'traefik.http.routers.sandboxvnc.rule=Host(`sandbox.localhost`) && PathPrefix(`/websockify`)'
      - 'traefik.http.routers.sandboxvnc.entrypoints=web'
      - 'traefik.http.routers.sandboxvnc.service=aio-vnc'

      # Jupyter Lab (port 8888)
      - 'traefik.http.services.aio-jupyter.loadbalancer.server.port=8888'
      - 'traefik.http.routers.jupyter.rule=Host(`jupyter.localhost`)'
      - 'traefik.http.routers.jupyter.entrypoints=web'
      - 'traefik.http.routers.jupyter.service=aio-jupyter'

      # Code Server (port 8200)
      - 'traefik.http.services.aio-code.loadbalancer.server.port=8200'
      - 'traefik.http.routers.code.rule=Host(`code.localhost`)'
      - 'traefik.http.routers.code.entrypoints=web'
      - 'traefik.http.routers.code.service=aio-code'
    networks:
      - traefik_default

networks:
  traefik_default:
    external: true
